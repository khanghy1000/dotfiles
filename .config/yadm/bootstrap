#!/bin/bash

RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
ENDCOLOR="\e[0m"

system_type=$(uname -s)
if ! [[ "$system_type" = "Linux" ]]; then
    echo -e "${RED}This script must be run on Linux!${ENDCOLOR}" 1>&2
    exit 1
fi

echo
echo -e "${GREEN}Installing packages...${ENDCOLOR}"
echo

pkgs=(fish zsh curl git make zip unzip gcc ripgrep xclip base-devel tmux fzf
    openssh openssh-client openssh-server bat tree jq neovim yazi uv zig
    ffmpegthumbnailer p7zip poppler fd zoxide imagemagick inotify-tools btop
    fastfetch blueman network-manager-applet pamixer pavucontrol)

# Load distribution info
if [ -f /etc/os-release ]; then
    . /etc/os-release
else
    ID="unknown"
    ID_LIKE="unknown"
fi

CMD_UPDATE=""
CMD_INSTALL=""
PKG_MANAGER=""

# Detect Package Manager
if [[ "$ID" == "ubuntu" || "$ID" == "linuxmint" || "$ID" == "debian" || "$ID_LIKE" == *"debian"* ]] || command -v apt-get >/dev/null 2>&1; then
    PKG_MANAGER="apt"
    CMD_UPDATE="sudo apt-get update && sudo apt-get upgrade -y"
    CMD_INSTALL="sudo apt-get -y --ignore-missing install"

elif [[ "$ID" == "fedora" || "$ID" == "rhel" || "$ID_LIKE" == *"fedora"* ]] || command -v dnf >/dev/null 2>&1; then
    PKG_MANAGER="dnf"
    CMD_UPDATE="sudo dnf upgrade --refresh -y"
    CMD_INSTALL="sudo dnf install -y --skip-unavailable"

elif [[ "$ID" == "arch" || "$ID" == "endeavouros" || "$ID_LIKE" == *"arch"* ]] || command -v pacman >/dev/null 2>&1; then
    PKG_MANAGER="pacman"
    CMD_UPDATE="sudo pacman -Syu --noconfirm"
    CMD_INSTALL="sudo pacman -S --needed --noconfirm"

elif [[ "$ID" == "opensuse" || "$ID_LIKE" == *"suse"* ]] || command -v zypper >/dev/null 2>&1; then
    PKG_MANAGER="zypper"
    CMD_UPDATE="sudo zypper refresh && sudo zypper update -y -l"
    CMD_INSTALL="sudo zypper install -y -l"
else
    echo -e "${RED}Unsupported distribution or package manager not found!${ENDCOLOR}"
    exit 1
fi

echo -e "${GREEN}Detected package manager: $PKG_MANAGER${ENDCOLOR}"

# Run Update
echo -e "${GREEN}Updating system...${ENDCOLOR}"
eval "$CMD_UPDATE"

# Run Install Loop
echo -e "${GREEN}Installing software list...${ENDCOLOR}"
for pkg in "${pkgs[@]}"; do
    $CMD_INSTALL "$pkg"
done

# Arch-specific: Install paru
if [[ "$PKG_MANAGER" == "pacman" ]]; then
    if ! command -v paru >/dev/null 2>&1; then
        echo -e "${GREEN}Installing paru...${ENDCOLOR}"
        git clone https://aur.archlinux.org/paru.git
        cd paru
        makepkg -si --noconfirm
        cd ..
        rm -rf paru
    fi
fi

echo
echo -e "${GREEN}Installing JetBrainsMono Nerd Font...${ENDCOLOR}"
echo

mkdir -p ~/.local/share/fonts
curl -L -o ~/JetBrainsMono.zip https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip
unzip ~/JetBrainsMono.zip -d ~/.local/share/fonts
rm ~/JetBrainsMono.zip
fc-cache -fv

echo
echo -e "${GREEN}Installing nvm...${ENDCOLOR}"
echo
PROFILE=/dev/null bash -c "$(curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh)"


echo
echo -e "${GREEN}Installing tpm...${ENDCOLOR}"
echo
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm

echo
echo -e "${GREEN}Installing starship...${ENDCOLOR}"
echo
curl -sS https://starship.rs/install.sh | sh

echo
echo -e "${GREEN}Setting up shell...${ENDCOLOR}"
echo

ZSH_PATH=$(which zsh)
FISH_PATH=$(which fish)

if [[ $FISH_PATH =~ "sbin" ]]; then
    FISH_PATH="${FISH_PATH//sbin/bin}"
    echo -e "${YELLOW}warning:${ENDCOLOR} shell path includes 'sbin'. Trying to change shell to $ZSH_PATH..."
fi

chsh -s $FISH_PATH

echo
echo -e "${GREEN}Installing antidote...${ENDCOLOR}"
echo
git clone --depth=1 https://github.com/mattmc3/antidote.git ${ZDOTDIR:-~}/.antidote

echo
echo -e "${GREEN}Installing Fisher...${ENDCOLOR}"
echo
fish -c "curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher"
fish -c "fisher install oh-my-fish/plugin-extract nickeb96/puffer-fish"

echo
echo "----------------------------------------"
echo
echo -e "${GREEN}Restart your terminal to apply changes!${ENDCOLOR}"
echo
echo "----------------------------------------"
echo
